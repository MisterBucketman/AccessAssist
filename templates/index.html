<!DOCTYPE html>
<html>
<head>
    <title>Accessibility Assistant</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        button { padding: 10px 15px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 4px; overflow: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Accessibility Assistant</h1>

        <div class="card">
            <h2>Website Information</h2>
            <input type="text" id="url" placeholder="Enter URL" value="http://localhost:8000/index.html" style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <input type="text" id="query" placeholder="What do you want to do?" style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 10px;">
                <input type="checkbox" id="use-live-session" checked title="Keep one browser tab open; scrape from it for continuous queries">
                Use persistent browser (keep tab open for series of queries)
            </label>
            <label style="display: block; margin-bottom: 10px;">
                <input type="checkbox" id="use-cache" title="Use saved scrape for this URL if available (only when persistent browser is off)">
                Use cached scrape if available
            </label>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="processRequest()">Process Request</button>
                <button onclick="scrapeOnly()" style="background: #6b7280;">Scrape page only</button>
                <button onclick="closeBrowserSession()" style="background: #991b1b;" id="close-session-btn">Close browser tab</button>
            </div>
            <div id="process-status" style="margin-top: 8px; font-size: 0.9em; color: #666;"></div>
            <div id="session-status" style="margin-top: 4px; font-size: 0.85em; color: #059669;"></div>
        </div>

        <div class="card">
            <h2>Assistant Guidance</h2>
            <div id="guidance-text">Submit a request to see instructions</div>
            <label style="display: block; margin-top: 10px; font-weight: bold;">Actions:</label>
            <textarea id="actions-json" rows="12" style="width: 100%; font-family: monospace; font-size: 13px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;" placeholder="Action sequence JSON will appear here. Edit to test what works."></textarea>
            <div style="margin-top: 10px;">
                <button onclick="markLLMResult(true)" id="mark-correct-btn" disabled>Mark as Correct</button>
                <button onclick="markLLMResult(false)" id="mark-incorrect-btn" disabled>Mark as Incorrect</button>
            </div>
        </div>

        <div class="card">
            <h2>Manual Recording</h2>
            <button onclick="startManualRecording()" id="manual-btn" disabled>Start Manual Recording</button>
            <div id="manual-status">Idle</div>
        </div>

        <script>
            async function markLLMResult(isCorrect) {
                if (!currentResponse) {
                    alert("No LLM result to label");
                    return;
                }
                const actions = getActionsFromTextarea();
                const actionSequence = (actions && actions.length > 0) ? actions : (currentResponse.llm_response?.action_sequence || []);
                const llmResponse = { ...(currentResponse.llm_response || {}), action_sequence: actionSequence };

                const url = document.getElementById('url').value;
                const query = document.getElementById('query').value;

                const payload = {
                    url: url,
                    query: query,
                    scraped_data: currentResponse.website_data,
                    llm_response: llmResponse,
                    correct: isCorrect
                };

                try {
                    const response = await fetch('/label_llm_result', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    alert(`LLM result marked as ${isCorrect ? "Correct" : "Incorrect"} and saved.`);
                } catch (err) {
                    console.error(err);
                    alert("Error saving label");
                }
            }

            async function startManualRecording() {
                if (!currentResponse) {
                    alert("No prior attempt to correct.");
                    return;
                }
                const actions = getActionsFromTextarea();
                const actionSequence = (actions && actions.length > 0) ? actions : (currentResponse.llm_response?.action_sequence || []);

                const url = document.getElementById('url').value;
                const query = document.getElementById('query').value;

                document.getElementById('manual-status').innerHTML = "Recording...";
                try {
                    const response = await fetch('/manual_record', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            url: url,
                            query: query,
                            original_scrape: currentResponse.website_data,
                            llm_action_sequence: actionSequence
                        })
                    });
                    const result = await response.json();
                    document.getElementById('manual-status').innerHTML = `Recording Finished!`;
                    console.log(result);
                } catch (err) {
                    document.getElementById('manual-status').innerHTML = `Error: ${err.message}`;
                }
            }
        </script>

        <div class="card">
            <h2>Execute Actions</h2>
            <button onclick="executeActions()" id="execute-btn">Execute Actions</button>
            <div id="execution-status">Ready</div>
            <div id="execution-steps" style="margin-top: 10px; font-size: 0.9em;"></div>
            <pre id="execution-logs" style="height: 200px; overflow: auto; background: #f4f4f4; padding: 10px; margin-top: 10px;"></pre>
        </div>

        <script>
            function getActionsFromTextarea() {
                const raw = document.getElementById('actions-json').value.trim();
                if (!raw) return null;
                try {
                    const parsed = JSON.parse(raw);
                    return Array.isArray(parsed) ? parsed : (parsed.action_sequence || [parsed]);
                } catch (e) {
                    return null;
                }
            }

            async function executeActions() {
                if (!currentResponse) {
                    alert("No request data. Please process a request first.");
                    return;
                }
                const actions = getActionsFromTextarea();
                if (!actions || actions.length === 0) {
                    alert("No actions to run. Enter a valid action sequence JSON in the Actions field (e.g. [{\"action\":\"click\",\"target\":\"...\"}]).");
                    return;
                }

                const url = document.getElementById('url').value;

                document.getElementById('execute-btn').disabled = true;
                document.getElementById('manual-btn').disabled = false;
                document.getElementById('execution-status').innerHTML = "Executing actions...";
                document.getElementById('execution-logs').textContent = "Starting execution...\n";
                document.getElementById('execution-steps').innerHTML = "";

                try {
                        const useLiveSession = document.getElementById('use-live-session').checked;
                    const response = await fetch('/execute', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            url,
                            actions,
                            query: document.getElementById('query').value.trim(),
                            use_live_session: useLiveSession
                        })
                    });

                    const result = await response.json();
                    if (result.website_data) {
                        currentResponse = { website_data: result.website_data, llm_response: currentResponse?.llm_response };
                        document.getElementById('scraped-data').textContent =
                            result.website_data.elements
                                ? JSON.stringify(result.website_data.elements, null, 2)
                                : '';
                    }
                    if (result.final_url) {
                        document.getElementById('url').value = result.final_url;
                    }
                    document.getElementById('execution-status').innerHTML =
                        result.status === "success" ? "Execution completed! Tab left open. Enter another query and click Process Request to continue." : "Execution finished with errors. Tab left open.";
                    if (result.final_url) {
                        document.getElementById('execution-status').innerHTML +=
                            " <a href=\"" + result.final_url + "\" target=\"_blank\">Open page</a>";
                    }
                    refreshSessionStatus();

                    if (result.steps && result.steps.length > 0) {
                        const stepsHtml = result.steps.map((s, i) => {
                            const ok = s.success ? "&#9989;" : "&#10060;";
                            const err = s.error ? " (" + s.error + ")" : "";
                            let detail = (s.target || "") + (s.value ? " = \"" + s.value + "\"" : "") + (s.key ? " key=\"" + s.key + "\"" : "") + (s.direction ? " " + s.direction + " " + (s.amount || "") : "");
                            return (i + 1) + ". " + ok + " " + s.action + " " + detail.trim() + err;
                        }).join("<br>");
                        document.getElementById('execution-steps').innerHTML = "<strong>Steps:</strong><br>" + stepsHtml;
                    }
                    if (result.logs) {
                        document.getElementById('execution-logs').textContent = result.logs;
                    }
                } catch (error) {
                    document.getElementById('execution-status').innerHTML = "Execution failed";
                    document.getElementById('execution-logs').textContent += "Error: " + error.message + "\n";
                } finally {
                    document.getElementById('execute-btn').disabled = false;
                }
            }
        </script>

        <style>
            #execute-btn:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }
        </style>

        <div class="card">
            <h2>Scraped Data</h2>
            <pre id="scraped-data"></pre>
        </div>
    </div>

    <button onclick="speakGuidance()">Read Guidance Aloud</button>

    <script>
        // Store the current response globally
        let currentResponse = null;

        document.addEventListener('DOMContentLoaded', function() {
            refreshSessionStatus();
        });

        async function processRequest() {
            const url = document.getElementById('url').value;
            const query = document.getElementById('query').value;
            const useCache = document.getElementById('use-cache').checked;
            const useLiveSession = document.getElementById('use-live-session').checked;
            const statusEl = document.getElementById('process-status');
            statusEl.textContent = 'Processing...';

            const response = await fetch('/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url, query, use_cache: useCache, use_live_session: useLiveSession })
            });

            const data = await response.json();
            if (!response.ok) {
                statusEl.textContent = data.error || 'Request failed';
                if (data.website_data) {
                    currentResponse = data;
                    document.getElementById('scraped-data').textContent =
                        JSON.stringify(data.website_data.elements, null, 2);
                }
                return;
            }

            currentResponse = data;
            if (data.current_url) document.getElementById('url').value = data.current_url;
            statusEl.textContent = data.from_session
                ? 'Scraped from open tab, then LLM. Enter another query to continue.'
                : (data.used_cache ? 'Used cached scrape, then LLM.' : 'Scraped page, then LLM.');
            refreshSessionStatus();

            const guidance = data.llm_response;
            if (guidance && guidance.action_sequence) {
                document.getElementById('guidance-text').innerHTML =
                    '<h3>Step-by-Step Guidance:</h3><p>' + (guidance.verbal_guide || '') + '</p>';
                document.getElementById('actions-json').value = JSON.stringify(guidance.action_sequence, null, 2);
                document.getElementById('mark-correct-btn').disabled = false;
                document.getElementById('mark-incorrect-btn').disabled = false;
            } else {
                document.getElementById('guidance-text').innerHTML =
                    '<p>Error: ' + ((guidance && guidance.error) || 'No guidance generated') + '</p>';
                document.getElementById('actions-json').value = '';
            }

            document.getElementById('scraped-data').textContent =
                data.website_data && data.website_data.elements
                    ? JSON.stringify(data.website_data.elements, null, 2)
                    : '';
        }

        async function scrapeOnly() {
            const url = document.getElementById('url').value;
            const statusEl = document.getElementById('process-status');
            statusEl.textContent = 'Scraping...';

            const response = await fetch('/scrape', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });

            const data = await response.json();
            if (!response.ok) {
                statusEl.textContent = data.error || 'Scrape failed';
                return;
            }

            currentResponse = { website_data: data.website_data, llm_response: null };
            statusEl.textContent = 'Page scraped and cached. Use "Process Request" with "Use cached scrape" to run LLM only.';
            document.getElementById('scraped-data').textContent =
                data.website_data && data.website_data.elements
                    ? JSON.stringify(data.website_data.elements, null, 2)
                    : '';
            document.getElementById('guidance-text').innerHTML = '<p>Scrape only. Run "Process Request" (with cached scrape) to get guidance.</p>';
            document.getElementById('actions-json').value = '';
        }


        async function refreshSessionStatus() {
            try {
                const r = await fetch('/session_status');
                const s = await r.json();
                const el = document.getElementById('session-status');
                if (s.has_session && s.current_url) {
                    el.textContent = 'Browser tab open at: ' + s.current_url;
                    el.style.color = '#059669';
                } else {
                    el.textContent = '';
                }
            } catch (e) {
                document.getElementById('session-status').textContent = '';
            }
        }

        async function closeBrowserSession() {
            try {
                const r = await fetch('/close_session', { method: 'POST' });
                const s = await r.json();
                if (s.status === 'success') {
                    document.getElementById('session-status').textContent = 'Browser closed.';
                    document.getElementById('session-status').style.color = '#666';
                } else {
                    document.getElementById('session-status').textContent = 'Error: ' + (s.error || 'unknown');
                }
            } catch (e) {
                document.getElementById('session-status').textContent = 'Error: ' + e.message;
            }
        }

        async function speakGuidance() {
            if (!currentResponse || !currentResponse.llm_response?.verbal_guide) {
                alert("No guidance available. Please process a request first.");
                return;
            }

            const guidance = currentResponse.llm_response.verbal_guide;
            await fetch('/speak', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: guidance })
            });
        }
    </script>
</body>
</html>